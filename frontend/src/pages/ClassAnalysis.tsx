import { useEffect, useState } from 'react';import { useNavigate, useParams } from 'react-router-dom';import { ArrowLeft, User } from 'lucide-react';import { useLanguage } from '../contexts/LanguageContext';import LanguageSelector from '../components/LanguageSelector';import Logo from '../components/Logo';import { classApi } from '../services/classApi';import { api } from '../services/api';import { aiApi } from '../services/aiApi';const ClassAnalysis = () => {  const navigate = useNavigate();  const { classId } = useParams<{ classId: string }>();  const { t, language } = useLanguage();  const [analysisData, setAnalysisData] = useState<any>(null);  const [user, setUser] = useState<any>(null);  const [isLoading, setIsLoading] = useState(true);  const [error, setError] = useState<string | null>(null);  const [classTeachingRecommendations, setClassTeachingRecommendations] = useState<any>(null);  const [isGeneratingClassTeaching, setIsGeneratingClassTeaching] = useState(false);  useEffect(() => {    if (classId) {      loadData();    }  }, [classId]);  const loadData = async () => {    if (!classId) return;    setIsLoading(true);    setError(null);    try {      const userResult = await api.getCurrentUser();      if (userResult.success && userResult.data) {        setUser(userResult.data.user);      }      const analysisResult = await classApi.getClassAnalysis(classId);      if (analysisResult.success && analysisResult.data) {        setAnalysisData(analysisResult.data);        if (analysisResult.data.statistics &&             (analysisResult.data.statistics.oceanAverages || analysisResult.data.statistics.logicalAverage > 0)) {          loadClassTeachingRecommendations();        }      } else {        setError(analysisResult.message || t('analysisNotFound'));      }    } catch (error: any) {      console.error('Load data error:', error);      setError(error.message || 'Failed to load analysis data');    } finally {      setIsLoading(false);    }  };  const handleBack = () => {    navigate(`/teacher/classes/${classId}`);  };  const loadClassTeachingRecommendations = async () => {    if (!classId) return;    setIsGeneratingClassTeaching(true);    try {      const result = await aiApi.generateClassTeachingRecommendations(classId);      if (result.success && result.data) {        setClassTeachingRecommendations(result.data);      }    } catch (error: any) {      console.error('Load class teaching recommendations error:', error);    } finally {      setIsGeneratingClassTeaching(false);    }  };  const getDonutChartData = () => {    try {      if (!analysisData?.distribution || analysisData.distribution.length === 0) {        return [];      }      const total = analysisData.distribution.reduce((sum: number, item: any) => sum + (item.count || 0), 0);      if (total === 0) return [];      return analysisData.distribution.map((item: any) => ({        ...item,        percentage: total > 0 ? Math.round((item.count / total) * 100) : 0,      }));    } catch (error) {      console.error('Error calculating donut chart data:', error);      return [];    }  };  const donutData = getDonutChartData();  const colors = ['#f97316', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899'];  const renderSidebar = () => (    <div className="fixed left-0 top-0 bottom-0 w-64 bg-white border-r-2 border-gray-900 flex flex-col z-10">      {}      <div className="px-6 py-6">        <Logo size={40} showText={true} />      </div>      {}      <div className="px-6 mb-4">        <button          onClick={handleBack}          className="w-full flex items-center gap-2 px-4 py-2 hover:bg-gray-100 rounded-md transition-colors"        >          <ArrowLeft size={20} className="text-gray-900" />          <span className="text-sm font-medium text-gray-900">{t('back')}</span>        </button>      </div>      {}      <div className="flex-1" />      {}      {user && (        <div           onClick={() => navigate('/teacher/profile')}          className="cursor-pointer hover:bg-gray-100 p-3 mx-4 mb-4 transition-colors"        >          <div className="flex items-center gap-3">            {user.profileImage ? (              <img                src={user.profileImage}                alt="Profile"                className="w-12 h-12 rounded-full object-cover border-2 border-gray-900 flex-shrink-0"              />            ) : (              <div className="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center border-2 border-gray-900 flex-shrink-0">                <User size={24} className="text-gray-400" />              </div>            )}            <div className="flex-1 min-w-0">              <p className="font-bold text-gray-900 text-sm truncate">                {user.name}              </p>              <p className="text-xs text-gray-600 truncate">                {user.email}              </p>            </div>          </div>        </div>      )}    </div>  );  if (isLoading) {    return (      <div className="min-h-screen bg-gray-50">        {renderSidebar()}        <div className="ml-64 flex items-center justify-center min-h-screen">          <div className="text-center">            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto"></div>            <p className="mt-4 text-gray-600">{t('loading')}</p>          </div>        </div>      </div>    );  }  if (error || !analysisData) {    return (      <div className="min-h-screen bg-gray-50">        {renderSidebar()}        <div className="ml-64 flex items-center justify-center min-h-screen">          <div className="text-center">            <p className="text-gray-600 text-lg mb-4">{error || t('analysisNotFound')}</p>            <button              onClick={handleBack}              className="px-6 py-3 bg-gray-900 text-white rounded-md hover:bg-gray-800 transition-colors"            >              {t('back')}            </button>          </div>        </div>      </div>    );  }  return (    <div className="min-h-screen bg-gray-50">      {}      {renderSidebar()}      {}      <div className="ml-64">        {}        <header className="bg-white border-b-2 border-gray-900">          <div className="container mx-auto px-4 py-4">            <div className="flex items-center justify-between">              <div>                <h1 className="text-2xl font-bold text-gray-900">                  {language === 'ja' ? 'クラス ' : 'Lớp '}{analysisData?.class?.name || t('classAnalysis')}                </h1>              </div>              <LanguageSelector />            </div>          </div>        </header>        {}        <main className="container mx-auto px-4 py-8">          {}          <div className="bg-white rounded-lg shadow-md border-2 border-gray-200 p-6 mb-8">            <h3 className="text-lg font-bold text-gray-900 mb-4">              {language === 'ja' ? 'クラス平均スコア' : 'Điểm trung bình của lớp'}            </h3>            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">              <div className="text-center bg-gray-50 rounded-lg p-4">                <p className="text-xs text-gray-600 mb-2">O</p>                <p className="text-sm font-medium text-gray-700 mb-1">{t('openness')}</p>                <p className="text-xl font-bold text-gray-900">                  {Math.round(analysisData?.statistics?.oceanAverages?.openness || 0)}%                </p>              </div>              <div className="text-center bg-gray-50 rounded-lg p-4">                <p className="text-xs text-gray-600 mb-2">C</p>                <p className="text-sm font-medium text-gray-700 mb-1">{t('conscientiousness')}</p>                <p className="text-xl font-bold text-gray-900">                  {Math.round(analysisData?.statistics?.oceanAverages?.conscientiousness || 0)}%                </p>              </div>              <div className="text-center bg-gray-50 rounded-lg p-4">                <p className="text-xs text-gray-600 mb-2">E</p>                <p className="text-sm font-medium text-gray-700 mb-1">{t('extraversion')}</p>                <p className="text-xl font-bold text-gray-900">                  {Math.round(analysisData?.statistics?.oceanAverages?.extraversion || 0)}%                </p>              </div>              <div className="text-center bg-gray-50 rounded-lg p-4">                <p className="text-xs text-gray-600 mb-2">A</p>                <p className="text-sm font-medium text-gray-700 mb-1">{t('agreeableness')}</p>                <p className="text-xl font-bold text-gray-900">                  {Math.round(analysisData?.statistics?.oceanAverages?.agreeableness || 0)}%                </p>              </div>              <div className="text-center bg-gray-50 rounded-lg p-4">                <p className="text-xs text-gray-600 mb-2">N</p>                <p className="text-sm font-medium text-gray-700 mb-1">{t('neuroticism')}</p>                <p className="text-xl font-bold text-gray-900">                  {Math.round(analysisData?.statistics?.oceanAverages?.neuroticism || 0)}%                </p>              </div>              <div className="text-center bg-gray-50 rounded-lg p-4">                <p className="text-xs text-gray-600 mb-2">Logic</p>                <p className="text-sm font-medium text-gray-700 mb-1">                  {language === 'ja' ? '論理的推論' : 'Logical'}                </p>                <p className="text-xl font-bold text-gray-900">                  {Math.round(analysisData?.statistics?.logicalAverage || 0)}%                </p>              </div>            </div>          </div>          {}          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">            {}            <div className="bg-white rounded-lg shadow-md border-2 border-gray-200 p-6">              <h3 className="text-lg font-bold text-gray-900 mb-4">                {language === 'ja' ? '学生の性格タイプ分布' : 'Phân bố tính cách học sinh trong lớp'}              </h3>              {}              <div className="mb-4 p-3 bg-gray-50 rounded-lg">                <p className="text-sm text-gray-700">                  <span className="font-medium">                    {language === 'ja' ? '総学生数: ' : 'Tổng số học sinh trong lớp: '}                  </span>                  <span className="font-bold text-gray-900">                    {analysisData?.statistics?.totalStudents || 0}                  </span>                </p>              </div>              {donutData.length > 0 ? (                <div className="flex items-center justify-center">                  <div className="relative w-64 h-64">                    <svg viewBox="0 0 200 200" className="transform -rotate-90">                      <circle                        cx="100"                        cy="100"                        r="80"                        fill="none"                        stroke="#e5e7eb"                        strokeWidth="40"                      />                      {donutData.map((item: any, index: number) => {                        try {                          const circumference = 2 * Math.PI * 80;                          const total = donutData.reduce((s: number, i: any) => s + (i.count || 0), 0);                          if (total === 0) return null;                          const offset = donutData.slice(0, index).reduce((sum: number, d: any) => {                            const prevPercentage = ((d.count || 0) / total) * 100;                            return sum + (prevPercentage / 100) * circumference;                          }, 0);                          const strokeDasharray = `${(item.percentage / 100) * circumference} ${circumference}`;                          return (                            <circle                              key={index}                              cx="100"                              cy="100"                              r="80"                              fill="none"                              stroke={colors[index % colors.length]}                              strokeWidth="40"                              strokeDasharray={strokeDasharray}                              strokeDashoffset={-offset}                              className="transition-all"                            />                          );                        } catch (error) {                          console.error('Error rendering donut segment:', error);                          return null;                        }                      })}                    </svg>                    <div className="absolute inset-0 flex items-center justify-center">                      <div className="text-center">                        <p className="text-2xl font-bold text-gray-900">                          {donutData.reduce((sum: number, item: any) => sum + (item.count || 0), 0)}                        </p>                        <p className="text-sm text-gray-600">                          {language === 'ja' ? '分類済み' : 'Đã phân loại'}                        </p>                      </div>                    </div>                  </div>                </div>              ) : (                <div className="text-center py-8 text-gray-500">                  <p>{t('noData')}</p>                </div>              )}              {}              {donutData.length > 0 && (                <div className="mt-6 space-y-3">                  {donutData.map((item: any, index: number) => (                    <div key={index} className="p-3 bg-gray-50 rounded-lg">                      <div className="flex items-center justify-between">                        <div className="flex items-center gap-2">                          <div                            className="w-4 h-4 rounded-full"                            style={{ backgroundColor: colors[index % colors.length] }}                          />                          <span className="text-sm font-medium text-gray-700">                            {typeof item.type === 'object' && item.type[language]                               ? item.type[language]                               : (typeof item.type === 'string' ? item.type : '-')}                          </span>                        </div>                        <span className="text-sm font-bold text-gray-900">                          {item.count} {language === 'ja' ? '人' : 'học sinh'} ({item.percentage}%)                        </span>                      </div>                    </div>                  ))}                </div>              )}            </div>            {}            <div className="bg-white rounded-lg shadow-md border-2 border-gray-200 p-6">              <h3 className="text-lg font-bold text-gray-900 mb-4">                {language === 'ja' ? 'クラス全体の指導方法提案' : 'Đề xuất phương pháp giảng dạy chung cho cả lớp'}              </h3>              <div className="max-h-[600px] overflow-y-auto pr-2">                {isGeneratingClassTeaching ? (                  <div className="text-center py-8">                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto mb-3"></div>                    <p className="text-gray-600">                      {language === 'ja'                         ? 'AI分析中...'                        : 'AI đang phân tích...'}                    </p>                  </div>                ) : classTeachingRecommendations ? (                  (() => {                    const recs = classTeachingRecommendations.recommendations?.[language] ||                                 classTeachingRecommendations.recommendations?.ja ||                                 classTeachingRecommendations.recommendations?.vi || [];                    if (recs.length === 0) {                      return (                        <div className="text-center py-8 text-gray-500">                          <p>{language === 'ja'                             ? '推奨事項がまだ生成されていません'                            : 'Chưa có gợi ý được tạo'}</p>                        </div>                      );                    }                    return (                      <div className="space-y-3">                        {recs.map((rec: string, index: number) => (                          <div key={index} className="bg-gray-50 rounded-lg p-4 border border-gray-200">                            <p className="text-sm font-medium text-gray-700 mb-2">                              {language === 'ja' ? `指導方法 ${index + 1}` : `Phương pháp ${index + 1}`}                            </p>                            <p className="text-sm text-gray-600">{rec}</p>                          </div>                        ))}                        {classTeachingRecommendations.generatedAt && (                          <p className="text-xs text-gray-500 text-center mt-4">                            {language === 'ja'                               ? `生成日時: ${new Date(classTeachingRecommendations.generatedAt).toLocaleString('ja-JP')}`                              : `Tạo lúc: ${new Date(classTeachingRecommendations.generatedAt).toLocaleString('vi-VN')}`}                          </p>                        )}                      </div>                    );                  })()                ) : analysisData?.statistics?.oceanAverages || analysisData?.statistics?.logicalAverage > 0 ? (                  <div className="space-y-3">                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">                      <p className="text-sm text-gray-700">                        {language === 'ja'                           ? 'このクラスの特性に基づいた指導方法を生成中です。しばらくお待ちください...'                          : 'Đang tạo phương pháp giảng dạy dựa trên đặc điểm của lớp này. Vui lòng đợi...'}                      </p>                    </div>                  </div>                ) : (                  <div className="text-center py-8 text-gray-500">                    <p>{language === 'ja'                       ? 'クラスにクイズ結果がまだありません'                      : 'Lớp chưa có kết quả quiz'}</p>                  </div>                )}              </div>            </div>          </div>        </main>      </div>    </div>  );};export default ClassAnalysis;