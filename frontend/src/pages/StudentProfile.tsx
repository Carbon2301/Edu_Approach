import { useEffect, useState, useRef } from 'react';import { useNavigate } from 'react-router-dom';import { ArrowLeft, Edit2, LogOut, Upload, Trash2, User, Save, X, Brain, BarChart3 } from 'lucide-react';import { useLanguage } from '../contexts/LanguageContext';import { useToastMessage } from '../contexts/ToastContext';import LanguageSelector from '../components/LanguageSelector';import { api, getImageUrl } from '../services/api';const StudentProfile = () => {  const navigate = useNavigate();  const { t, language } = useLanguage();  const toast = useToastMessage();  const fileInputRef = useRef<HTMLInputElement>(null);  const [user, setUser] = useState<any>(null);  const [isLoading, setIsLoading] = useState(true);  const [isEditing, setIsEditing] = useState(false);  const [isSaving, setIsSaving] = useState(false);  const [formData, setFormData] = useState({    name: '',    email: '',    location: '',    studentId: '',    selfIntro: '',    gender: '' as 'male' | 'female' | 'other' | '',  });  const [profileImage, setProfileImage] = useState<string | null>(null);  const [profileImageFile, setProfileImageFile] = useState<File | null>(null);  const [errors, setErrors] = useState<{ [key: string]: string }>({});  const [dashboardData, setDashboardData] = useState<any>(null);  useEffect(() => {    loadUser();  }, []);  const loadUser = async () => {    setIsLoading(true);    try {      const result = await api.getCurrentUser();      if (result.success && result.data) {        const userData = result.data.user;        setUser(userData);        setFormData({          name: userData.name || '',          email: userData.email || '',          location: userData.location || '',          studentId: userData.studentId || '',          selfIntro: userData.selfIntro || '',          gender: userData.gender || '',        });        setProfileImage(userData.profileImage);        if (userData.role === 'student') {          loadDashboardData();        }      }    } catch (error) {      console.error('Load user error:', error);    } finally {      setIsLoading(false);    }  };  const loadDashboardData = async () => {    try {      const result = await api.getStudentDashboard();      if (result.success && result.data) {        setDashboardData(result.data);      }    } catch (error) {      console.error('Load dashboard data error:', error);    }  };  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {    const { name, value } = e.target;    setFormData(prev => ({ ...prev, [name]: value }));    if (errors[name]) {      setErrors(prev => ({ ...prev, [name]: '' }));    }  };  const handleImageUpload = (e: React.ChangeEvent<HTMLInputElement>) => {    const file = e.target.files?.[0];    if (file) {      if (!file.type.startsWith('image/')) {        toast.error('imageUploadOnly');        if (fileInputRef.current) {          fileInputRef.current.value = '';        }        return;      }      const maxSize = 5 * 1024 * 1024; 
      if (file.size > maxSize) {        toast.error('imageSizeLimit');        if (fileInputRef.current) {          fileInputRef.current.value = '';        }        return;      }      setProfileImageFile(file);      const reader = new FileReader();      reader.onloadend = () => {        setProfileImage(reader.result as string);      };      reader.onerror = () => {        toast.error('imageReadFailed');        if (fileInputRef.current) {          fileInputRef.current.value = '';        }      };      reader.readAsDataURL(file);    }  };  const handleImageDelete = async () => {    if (window.confirm(language === 'ja' ? '画像を削除しますか？' : 'Bạn có muốn xóa ảnh?')) {      try {        const result = await api.deleteProfileImage();        if (result.success) {        setProfileImage(null);        setProfileImageFile(null);        if (fileInputRef.current) {          fileInputRef.current.value = '';        }          toast.success('imageDeleted');          loadUser();        } else {          toast.error('imageDeleteFailed', result.message);        }      } catch (error: any) {        console.error('Delete image error:', error);        toast.error('imageDeleteFailed', error.message);      }    }  };  const handleSave = async () => {    setIsSaving(true);    try {      const result = await api.updateProfile({        name: formData.name,        location: formData.location,        studentId: formData.studentId,        selfIntro: formData.selfIntro,        gender: formData.gender || undefined,        profileImage: profileImageFile,      });      if (result.success) {        if (result.data?.user?.profileImage) {          setProfileImage(getImageUrl(result.data.user.profileImage));        }      toast.success('saveSuccess');      setIsEditing(false);        setProfileImageFile(null);        setErrors({});        if (fileInputRef.current) {          fileInputRef.current.value = '';        }      loadUser();      } else {        const errorMessage = result.message;        if (errorMessage && (errorMessage.toLowerCase().includes('student id') || errorMessage.toLowerCase().includes('mssv'))) {          setErrors({ studentId: errorMessage });        }        toast.error('saveFailed', errorMessage);      }    } catch (error: any) {      console.error('Save error:', error);      const errorMessage = error.message;      if (errorMessage && (errorMessage.toLowerCase().includes('student id') || errorMessage.toLowerCase().includes('mssv'))) {        setErrors({ studentId: errorMessage });      }      toast.error('saveFailed', errorMessage);    } finally {      setIsSaving(false);    }  };  const handleCancel = () => {    setIsEditing(false);    setErrors({});    loadUser(); 
  };  const handleDeleteAccount = async () => {    const confirmText = language === 'ja'       ? 'アカウントを削除しますか？この操作は取り消せません。'      : 'Bạn có chắc muốn xóa tài khoản? Hành động này không thể hoàn tác.';    if (window.confirm(confirmText)) {      try {        toast.success('accountDeleted');        api.logout();        navigate('/');      } catch (error) {        console.error('Delete account error:', error);        toast.error('accountDeleteFailed');      }    }  };  const handleLogout = () => {    api.logout();    navigate('/login');  };  if (isLoading) {    return (      <div className="min-h-screen bg-gray-50 flex items-center justify-center">        <div className="text-center">          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto"></div>          <p className="mt-4 text-gray-600">{t('loading')}...</p>        </div>      </div>    );  }  return (    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50">      {}      <header className="bg-white border-b border-gray-200 shadow-sm">        <div className="container mx-auto px-4 py-4">          <div className="flex justify-between items-center">            <div className="flex items-center gap-4">              <button                onClick={() => navigate('/dashboard')}                className="p-2 hover:bg-gray-100 rounded-full transition-colors"              >                <ArrowLeft size={24} />              </button>              <span className="text-xl font-bold text-gray-900">{t('appName')}</span>            </div>            <div className="flex items-center gap-4">              <LanguageSelector />              {!isEditing ? (                <button                  onClick={() => setIsEditing(true)}                  className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors flex items-center gap-2"                >                  <Edit2 size={20} />                  <span className="hidden md:inline">                    {language === 'ja' ? '編集' : 'Chỉnh sửa'}                  </span>                </button>              ) : (                <button                  onClick={handleCancel}                  className="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors flex items-center gap-2"                >                  <X size={20} />                  <span className="hidden md:inline">                    {language === 'ja' ? 'キャンセル' : 'Hủy'}                  </span>                </button>              )}              <button                onClick={handleLogout}                className="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-md transition-colors flex items-center gap-2"              >                <LogOut size={20} />                <span className="hidden md:inline">{t('logout')}</span>              </button>            </div>          </div>        </div>      </header>      {}      <main className="container mx-auto px-4 py-12">        <div className="max-w-7xl mx-auto">          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">            {}            <div className="space-y-6">              {}              <div className="bg-white rounded-2xl shadow-lg p-8 border-2 border-gray-900">                <div className="flex flex-col items-center">                  <div className="relative mb-4">                    <div className="w-32 h-32 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden border-4 border-gray-900">                      {profileImage ? (                        <img src={profileImage} alt="Profile" className="w-full h-full object-cover" />                      ) : (                        <User size={64} className="text-gray-400" />                      )}                    </div>                    <div className="absolute -bottom-2 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-4 py-1 rounded-full text-sm font-bold">                      D                    </div>                  </div>                  {isEditing && (                    <div className="flex gap-3">                      <button                        type="button"                        onClick={() => fileInputRef.current?.click()}                        className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm"                      >                        <Upload size={16} />                        {language === 'ja' ? '画像を更新' : 'Cập nhật ảnh'}                      </button>                      {profileImage && (                        <button                          type="button"                          onClick={handleImageDelete}                          className="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors text-sm"                        >                          <Trash2 size={16} />                          {language === 'ja' ? '画像を削除' : 'Xóa ảnh'}                        </button>                      )}                    </div>                  )}                  <input                    ref={fileInputRef}                    type="file"                    accept="image/*"                    onChange={handleImageUpload}                    className="hidden"                  />                </div>              </div>              {}              {user?.role === 'student' && dashboardData && (                <div className="space-y-6">                  {}                  {dashboardData.studentClassification && (                    <div className="bg-gradient-to-br from-green-50 to-emerald-100 rounded-lg p-6 border-2 border-green-200">                      <div className="flex items-center gap-3 mb-2">                        <div className="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center">                          <User size={20} className="text-white" />                        </div>                        <div className="flex-1">                          <p className="text-sm text-gray-600 mb-1">                            {language === 'ja' ? 'あなたのタイプ' : 'Loại tính cách học sinh'}                          </p>                          <p className="text-2xl font-bold text-gray-900">                            {dashboardData.studentClassification.name[language] || dashboardData.studentClassification.name.vi}                          </p>                        </div>                      </div>                    </div>                  )}                  {}                  {dashboardData.latestOceanResult?.scores && (                    <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-6 border-2 border-blue-200">                      <div className="flex items-center gap-3 mb-4">                        <div className="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center">                          <Brain size={20} className="text-white" />                        </div>                        <h3 className="text-lg font-bold text-gray-900">                          {language === 'ja' ? 'OCEAN パーソナリティスコア' : 'Điểm tính cách OCEAN (%)'}                        </h3>                      </div>                      <div className="space-y-4">                        {Object.entries(dashboardData.latestOceanResult.scores).map(([trait, score]: [string, any]) => {                          const traitNames: { [key: string]: { vi: string; ja: string } } = {                            openness: { vi: 'Cởi mở', ja: '開放性' },                            conscientiousness: { vi: 'Tận tâm', ja: '誠実性' },                            extraversion: { vi: 'Hướng ngoại', ja: '外向性' },                            agreeableness: { vi: 'Dễ chịu', ja: '協調性' },                            neuroticism: { vi: 'Nhạy cảm', ja: '神経症傾向' },                          };                          const traitName = traitNames[trait]?.[language] || trait;                          return (                            <div key={trait} className="bg-white rounded-lg p-4 border border-blue-200">                              <div className="flex justify-between items-center mb-2">                                <span className="text-sm font-medium text-gray-700">{traitName}</span>                                <span className="text-lg font-bold text-blue-600">{score}%</span>                              </div>                              <div className="w-full bg-gray-200 rounded-full h-2">                                <div                                  className="bg-blue-600 h-2 rounded-full transition-all"                                  style={{ width: `${score}%` }}                                />                              </div>                            </div>                          );                        })}                      </div>                    </div>                  )}                  {}                  {dashboardData.latestLogicalResult && (                    <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-6 border-2 border-purple-200">                      <div className="flex items-center gap-3 mb-4">                        <div className="w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center">                          <BarChart3 size={20} className="text-white" />                        </div>                        <h3 className="text-lg font-bold text-gray-900">                          {language === 'ja' ? '論理テスト結果' : 'Kết quả Logical Test'}                        </h3>                      </div>                      <div className="bg-white rounded-lg p-6 border border-purple-200">                        <div className="flex justify-between items-center mb-4">                          <span className="text-sm text-gray-600">                            {language === 'ja' ? '正解数' : 'Số câu đúng'}                          </span>                          <span className="text-2xl font-bold text-purple-600">                            {dashboardData.latestLogicalResult.correctCount || 0} / {dashboardData.latestLogicalResult.totalQuestions || 0}                          </span>                        </div>                        <div className="mb-2">                          <div className="flex justify-between items-center mb-2">                            <span className="text-sm font-medium text-gray-700">                              {language === 'ja' ? '正答率' : 'Tỷ lệ đúng'}                            </span>                            <span className="text-xl font-bold text-purple-600">                              {dashboardData.latestLogicalResult.percentage || 0}%                            </span>                          </div>                          <div className="w-full bg-gray-200 rounded-full h-3">                            <div                              className="bg-purple-600 h-3 rounded-full transition-all"                              style={{ width: `${dashboardData.latestLogicalResult.percentage || 0}%` }}                            />                          </div>                        </div>                      </div>                    </div>                  )}                  {}                  {!dashboardData.latestOceanResult && !dashboardData.latestLogicalResult && (                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">                      <p className="text-yellow-800 text-sm">                        {language === 'ja'                           ? 'まだクイズ結果がありません。クイズを完了すると、ここに結果が表示されます。'                          : 'Chưa có kết quả quiz. Hoàn thành quiz để xem kết quả tại đây.'}                      </p>                    </div>                  )}                </div>              )}            </div>            {}            <div className="bg-white rounded-2xl shadow-lg p-8 border-2 border-gray-900">              <div className="space-y-5">              {}              <div>                <label className="block text-sm font-medium text-gray-700 mb-2">                  {language === 'ja' ? '名前' : 'Họ và tên'}                </label>                <input                  type="text"                  name="name"                  value={formData.name}                  onChange={handleInputChange}                  disabled={!isEditing}                  className="input-field disabled:bg-gray-50 disabled:text-gray-600"                />              </div>              {}              <div>                <label className="block text-sm font-medium text-gray-700 mb-2">                  {language === 'ja' ? 'メールアドレス' : 'Email'}                </label>                <input                  type="email"                  name="email"                  value={formData.email}                  onChange={handleInputChange}                  disabled={true}                  className="input-field bg-gray-100 text-gray-500 cursor-not-allowed"                />                <p className="text-xs text-gray-500 mt-1">                  {language === 'ja' ? 'メールアドレスは変更できません' : 'Email không thể thay đổi'}                </p>              </div>              {}              <div>                <label className="block text-sm font-medium text-gray-700 mb-2">                  {language === 'ja' ? '性別' : 'Giới tính'}                </label>                <select                  name="gender"                  value={formData.gender}                  onChange={(e) => setFormData(prev => ({ ...prev, gender: e.target.value as any }))}                  disabled={!isEditing}                  className="input-field disabled:bg-gray-50 disabled:text-gray-600"                >                  <option value="">{language === 'ja' ? '選択してください' : 'Chọn giới tính'}</option>                  <option value="male">{language === 'ja' ? '男性' : 'Nam'}</option>                  <option value="female">{language === 'ja' ? '女性' : 'Nữ'}</option>                  <option value="other">{language === 'ja' ? 'その他' : 'Khác'}</option>                </select>              </div>              {}              {user?.role === 'student' && (                <div>                  <label className="block text-sm font-medium text-gray-700 mb-2">                    {language === 'ja' ? '学生番号' : 'Mã sinh viên'}                  </label>                  <input                    type="text"                    name="studentId"                    value={formData.studentId}                    onChange={handleInputChange}                    disabled={!isEditing}                    className={`input-field disabled:bg-gray-50 disabled:text-gray-600 ${errors.studentId ? 'border-red-500' : ''}`}                  />                  {errors.studentId && (                    <p className="mt-1 text-sm text-red-600">{errors.studentId}</p>                  )}                </div>              )}              {}              <div>                <label className="block text-sm font-medium text-gray-700 mb-2">                  {language === 'ja' ? '自己紹介' : 'Giới thiệu bản thân'}                </label>                <textarea                  name="selfIntro"                  value={formData.selfIntro}                  onChange={handleInputChange}                  disabled={!isEditing}                  rows={4}                  placeholder={language === 'ja'                     ? '私のプロフィールへようこそ。ここでしばらく。'                    : 'Chào mừng đến với hồ sơ của tôi...'}                  className="input-field resize-none disabled:bg-gray-50 disabled:text-gray-600"                />              </div>              {}              {isEditing && (                <div className="flex gap-4 pt-4">                  <button                    onClick={handleSave}                    disabled={isSaving}                    className="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"                  >                    <Save size={20} />                    {isSaving                       ? (language === 'ja' ? '保存中...' : 'Đang lưu...')                      : (language === 'ja' ? '変更を保存' : 'Lưu thay đổi')                    }                  </button>                  <button                    onClick={handleCancel}                    className="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors"                  >                    {language === 'ja' ? 'キャンセル' : 'Hủy'}                  </button>                </div>              )}                {}                <div className="pt-6 border-t border-gray-200">                  <button                    onClick={handleDeleteAccount}                    className="w-full px-6 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors flex items-center justify-center gap-2"                  >                    <Trash2 size={20} />                    {language === 'ja' ? 'アカウントを削除' : 'Xóa tài khoản'}                  </button>                  <p className="text-xs text-gray-500 text-center mt-2">                    {language === 'ja'                       ? 'この操作は取り消せません。慎重に行ってください。'                      : 'Hành động này không thể hoàn tác. Hãy cẩn thận.'}                  </p>                </div>              </div>            </div>          </div>        </div>      </main>    </div>  );};export default StudentProfile;