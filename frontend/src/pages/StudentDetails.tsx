import { useEffect, useState } from 'react';import { useNavigate, useParams } from 'react-router-dom';import { ArrowLeft, User } from 'lucide-react';import { useLanguage } from '../contexts/LanguageContext';import LanguageSelector from '../components/LanguageSelector';import Logo from '../components/Logo';import { classApi } from '../services/classApi';import { api } from '../services/api';import { aiApi } from '../services/aiApi';const StudentDetails = () => {  const navigate = useNavigate();  const { classId, studentId } = useParams<{ classId: string; studentId: string }>();  const { t, language } = useLanguage();  const [studentData, setStudentData] = useState<any>(null);  const [user, setUser] = useState<any>(null);  const [isLoading, setIsLoading] = useState(true);  const [teachingRecommendations, setTeachingRecommendations] = useState<any>(null);  const [isGeneratingTeaching, setIsGeneratingTeaching] = useState(false);  const [error, setError] = useState<string | null>(null);  useEffect(() => {    if (classId && studentId) {      setStudentData(null);      setTeachingRecommendations(null);      setIsGeneratingTeaching(false);      setError(null);      loadData();    }  }, [classId, studentId]);  const loadData = async () => {    if (!classId || !studentId) return;    setIsLoading(true);    setError(null);    try {      const userResult = await api.getCurrentUser();      if (userResult.success && userResult.data) {        setUser(userResult.data.user);      }      const studentResult = await classApi.getStudentDetails(classId, studentId);      if (studentResult.success && studentResult.data) {        setStudentData(studentResult.data);        if (studentResult.data.latestOceanResult || studentResult.data.latestLogicalResult) {          loadTeachingRecommendations();        }      } else {        setError(studentResult.message || t('studentNotFound'));      }    } catch (error: any) {      console.error('Load data error:', error);      setError(error.message || 'Failed to load student data');    } finally {      setIsLoading(false);    }  };  const handleBack = () => {    navigate(`/teacher/classes/${classId}`);  };  const loadTeachingRecommendations = async () => {    if (!classId || !studentId) return;    setIsGeneratingTeaching(true);    try {      const result = await aiApi.generateTeachingRecommendations(classId, studentId);      if (result.success && result.data) {        setTeachingRecommendations(result.data);      }    } catch (error: any) {      console.error('Load teaching recommendations error:', error);    } finally {      setIsGeneratingTeaching(false);    }  };  const getPersonalityTypeLabel = (trait: string | null | undefined) => {    if (!trait) return '-';    const typeMap: { [key: string]: { ja: string; vi: string } } = {      'neuroticism': { ja: t('emotional') || '感情型', vi: t('emotional') || 'Cảm xúc' },      'extraversion': { ja: t('extroverted') || '外向型', vi: t('extroverted') || 'Hướng ngoại' },      'openness': { ja: t('creative') || '創造型', vi: t('creative') || 'Sáng tạo' },      'agreeableness': { ja: t('cooperative') || '協調型', vi: t('cooperative') || 'Hợp tác' },      'conscientiousness': { ja: t('organized') || '組織型', vi: t('organized') || 'Có tổ chức' },    };    const label = typeMap[trait]?.[language];    return label || '-';  };  const renderSidebar = () => (    <div className="fixed left-0 top-0 bottom-0 w-64 bg-white border-r-2 border-gray-900 flex flex-col z-10">      {}      <div className="px-6 py-6">        <Logo size={40} showText={true} />      </div>      {}      <div className="px-6 mb-4">        <button          onClick={handleBack}          className="w-full flex items-center gap-2 px-4 py-2 hover:bg-gray-100 rounded-md transition-colors"        >          <ArrowLeft size={20} className="text-gray-900" />          <span className="text-sm font-medium text-gray-900">{t('back')}</span>        </button>      </div>      {}      <div className="flex-1" />      {}      {user && (        <div           onClick={() => navigate('/teacher/profile')}          className="cursor-pointer hover:bg-gray-100 p-3 mx-4 mb-4 transition-colors"        >          <div className="flex items-center gap-3">            {user.profileImage ? (              <img                src={user.profileImage}                alt="Profile"                className="w-12 h-12 rounded-full object-cover border-2 border-gray-900 flex-shrink-0"              />            ) : (              <div className="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center border-2 border-gray-900 flex-shrink-0">                <User size={24} className="text-gray-400" />              </div>            )}            <div className="flex-1 min-w-0">              <p className="font-bold text-gray-900 text-sm truncate">                {user.name}              </p>              <p className="text-xs text-gray-600 truncate">                {user.email}              </p>            </div>          </div>        </div>      )}    </div>  );  if (isLoading) {    return (      <div className="min-h-screen bg-gray-50">        {renderSidebar()}        <div className="ml-64 flex items-center justify-center min-h-screen">          <div className="text-center">            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto"></div>            <p className="mt-4 text-gray-600">{t('loading')}</p>          </div>        </div>      </div>    );  }  if (error || !studentData) {    return (      <div className="min-h-screen bg-gray-50">        {renderSidebar()}        <div className="ml-64 flex items-center justify-center min-h-screen">          <div className="text-center">            <p className="text-gray-600 text-lg mb-4">{error || t('studentNotFound')}</p>            <button              onClick={handleBack}              className="px-6 py-3 bg-gray-900 text-white rounded-md hover:bg-gray-800 transition-colors"            >              {t('back')}            </button>          </div>        </div>      </div>    );  }  const student = studentData.student;  const latestOceanResult = studentData.latestOceanResult;  const latestLogicalResult = studentData.latestLogicalResult;  const studentClassification = studentData.studentClassification;  const personalityType = studentClassification    ? studentClassification.name[language]    : (latestOceanResult?.dominantTrait         ? getPersonalityTypeLabel(latestOceanResult.dominantTrait)        : '-');  return (    <div className="min-h-screen bg-gray-50">      {}      {renderSidebar()}      {}      <div className="ml-64">        {}        <header className="bg-white border-b-2 border-gray-900">          <div className="container mx-auto px-4 py-4">            <div className="flex items-center justify-end">              <LanguageSelector />            </div>          </div>        </header>        {}        <main className="container mx-auto px-4 py-8 space-y-6">          {}          <div className="bg-white rounded-lg shadow-md border-2 border-gray-200 p-6">            <div className="flex items-center gap-4 mb-4">              {student.profileImage ? (                <img                  src={student.profileImage}                  alt={student.name}                  className="w-20 h-20 rounded-full object-cover border-2 border-gray-900"                />              ) : (                <div className="w-20 h-20 rounded-full bg-gray-200 flex items-center justify-center border-2 border-gray-900">                  <User size={40} className="text-gray-400" />                </div>              )}              <div>                <h3 className="text-xl font-bold text-gray-900">{student.name}</h3>                <span className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">                  {t('active')}                </span>              </div>            </div>            <div className="space-y-2 text-sm">              <div>                <span className="font-medium text-gray-700">{t('studentId')}: </span>                <span className="text-gray-600">{student.studentId || '-'}</span>              </div>              <div>                <span className="font-medium text-gray-700">{t('email')}: </span>                <span className="text-gray-600">{student.email}</span>              </div>              <div>                <span className="font-medium text-gray-700">                  {language === 'ja' ? '性別' : 'Giới tính'}:{' '}                </span>                <span className="text-gray-600">                  {(() => {                    if (!student.gender) return '-';                    if (language === 'ja') {                      return student.gender === 'male' ? '男性' : student.gender === 'female' ? '女性' : 'その他';                    }                    return student.gender === 'male' ? 'Nam' : student.gender === 'female' ? 'Nữ' : 'Khác';                  })()}                </span>              </div>              {student.phone && (                <div>                  <span className="font-medium text-gray-700">{t('phone')}: </span>                  <span className="text-gray-600">{student.phone}</span>                </div>              )}              {studentData.class?.name && (                <div>                  <span className="font-medium text-gray-700">                    {language === 'ja' ? 'クラス' : 'Lớp'}:{' '}                  </span>                  <span className="text-gray-600">                    {language === 'ja' ? 'クラス ' : 'Lớp '}{studentData.class.name}                  </span>                </div>              )}            </div>          </div>          {}          <div className="bg-white rounded-lg shadow-md border-2 border-gray-200 p-6">            <h3 className="text-lg font-bold text-gray-900 mb-4">{t('studentSummary')}</h3>            <div className="mb-4">              {}              <div className="bg-gray-50 rounded-lg p-4 max-w-md">                <p className="text-sm text-gray-600 mb-2">{t('characterType')}</p>                <p className="text-lg font-bold text-gray-900">{personalityType}</p>              </div>            </div>            {}            <div className="pt-4 border-t border-gray-200">              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">                {}                {latestLogicalResult ? (                  <div>                    <p className="text-sm font-medium text-gray-700 mb-3">                      {language === 'ja' ? '論理的推論スコア' : 'Điểm Logical'}                    </p>                    <div className="bg-gray-50 rounded-lg p-4 text-center">                      <p className="text-2xl font-bold text-gray-900">                        {latestLogicalResult.correctCount}/{latestLogicalResult.totalQuestions}                      </p>                      <p className="text-sm text-gray-600 mt-1">                        ({latestLogicalResult.percentage || Math.round((latestLogicalResult.correctCount / latestLogicalResult.totalQuestions) * 100)}%)                      </p>                    </div>                  </div>                ) : null}                {}                {latestOceanResult?.scores && (                  <div className={latestLogicalResult ? 'border-l border-gray-200 pl-6' : ''}>                    <p className="text-sm font-medium text-gray-700 mb-3">{t('oceanScores')}</p>                    <div className="grid grid-cols-5 gap-3">                      <div className="bg-gray-50 rounded-lg p-3 text-center">                        <p className="text-xs text-gray-600 mb-1">{t('neuroticism')}</p>                        <p className="text-lg font-bold text-gray-900">{latestOceanResult.scores.neuroticism || 0}%</p>                      </div>                      <div className="bg-gray-50 rounded-lg p-3 text-center">                        <p className="text-xs text-gray-600 mb-1">{t('extraversion')}</p>                        <p className="text-lg font-bold text-gray-900">{latestOceanResult.scores.extraversion || 0}%</p>                      </div>                      <div className="bg-gray-50 rounded-lg p-3 text-center">                        <p className="text-xs text-gray-600 mb-1">{t('openness')}</p>                        <p className="text-lg font-bold text-gray-900">{latestOceanResult.scores.openness || 0}%</p>                      </div>                      <div className="bg-gray-50 rounded-lg p-3 text-center">                        <p className="text-xs text-gray-600 mb-1">{t('agreeableness')}</p>                        <p className="text-lg font-bold text-gray-900">{latestOceanResult.scores.agreeableness || 0}%</p>                      </div>                      <div className="bg-gray-50 rounded-lg p-3 text-center">                        <p className="text-xs text-gray-600 mb-1">{t('conscientiousness')}</p>                        <p className="text-lg font-bold text-gray-900">{latestOceanResult.scores.conscientiousness || 0}%</p>                      </div>                    </div>                  </div>                )}              </div>            </div>          </div>          {}          <div className="bg-white rounded-lg shadow-md border-2 border-gray-200 p-6">                <h3 className="text-lg font-bold text-gray-900 mb-4">{t('proposedApproach')}</h3>                {isGeneratingTeaching ? (                  <div className="text-center py-8">                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto mb-3"></div>                    <p className="text-gray-600">                      {language === 'ja'                         ? 'AI分析中...'                        : 'AI đang phân tích...'}                    </p>                  </div>                ) : teachingRecommendations ? (                  (() => {                    const recs = teachingRecommendations.recommendations?.[language] ||                                 teachingRecommendations.recommendations?.ja ||                                 teachingRecommendations.recommendations?.vi || [];                    if (recs.length === 0) {                      return (                        <div className="text-center py-8 text-gray-500">                          <p>{language === 'ja'                             ? '推奨事項がまだ生成されていません'                            : 'Chưa có gợi ý được tạo'}</p>                        </div>                      );                    }                    return (                      <div className="space-y-3">                        {recs.map((rec: string, index: number) => (                          <div key={index} className="bg-gray-50 rounded-lg p-4 border border-gray-200">                            <p className="text-sm font-medium text-gray-700 mb-2">                              {language === 'ja' ? `指導方法 ${index + 1}` : `Phương pháp ${index + 1}`}                            </p>                            <p className="text-sm text-gray-600">{rec}</p>                          </div>                        ))}                        {teachingRecommendations.generatedAt && (                          <p className="text-xs text-gray-500 text-center mt-4">                            {language === 'ja'                               ? `生成日時: ${new Date(teachingRecommendations.generatedAt).toLocaleString('ja-JP')}`                              : `Tạo lúc: ${new Date(teachingRecommendations.generatedAt).toLocaleString('vi-VN')}`}                          </p>                        )}                      </div>                    );                  })()                ) : latestOceanResult || latestLogicalResult ? (                  <div className="space-y-3">                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">                      <p className="text-sm text-gray-700">                        {language === 'ja'                           ? 'この学生の性格タイプに基づいた指導アプローチを生成中です。しばらくお待ちください...'                          : 'Đang tạo phương pháp giảng dạy dựa trên loại tính cách của sinh viên này. Vui lòng đợi...'}                      </p>                    </div>                  </div>                ) : (                  <div className="text-center py-8 text-gray-500">                    <p>{t('noQuizResults')}</p>                  </div>                )}          </div>        </main>      </div>    </div>  );};export default StudentDetails;