import { useEffect, useState } from 'react';import { useNavigate, useParams } from 'react-router-dom';import { ArrowLeft, Clock, User } from 'lucide-react';import { useLanguage } from '../contexts/LanguageContext';import { useToastMessage } from '../contexts/ToastContext';import LanguageSelector from '../components/LanguageSelector';import Logo from '../components/Logo';import { quizApi, QuizAnswer } from '../services/quizApi';import { api } from '../services/api';import { getOceanOptions } from '../utils/getTranslatedQuizOptions';import { translateQuiz, translateQuestion } from '../utils/translateQuizData';const QuizTaking = () => {  const { quizId } = useParams<{ quizId: string }>();  const navigate = useNavigate();  const { t, language } = useLanguage();  const toast = useToastMessage();  const [quiz, setQuiz] = useState<any>(null);  const [questions, setQuestions] = useState<any[]>([]);  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);  const [answers, setAnswers] = useState<Map<string, number>>(new Map());  const [isLoading, setIsLoading] = useState(true);  const [isSubmitting, setIsSubmitting] = useState(false);  const [user, setUser] = useState<any>(null);  useEffect(() => {    if (quizId) {      loadQuiz();    }  }, [quizId]);  const loadQuiz = async () => {    setIsLoading(true);    try {      const userResult = await api.getCurrentUser();      if (userResult.success && userResult.data) {        setUser(userResult.data.user);      }      const result = await quizApi.getQuizQuestions(quizId!);      if (result.success && result.data) {        setQuiz(result.data.quiz);        setQuestions(result.data.questions);      } else {        console.error('Failed to load quiz:', result.message);        toast.error('quizLoadFailed', result.message);        setTimeout(() => {          navigate('/quizzes');        }, 2000);      }    } catch (error: any) {      console.error('Load quiz error:', error);      toast.error('quizLoadFailed', error.message);      setTimeout(() => {        navigate('/quizzes');      }, 2000);    } finally {      setIsLoading(false);    }  };  const handleAnswerSelect = (answer: number) => {    const actualQuestion = questions[currentQuestionIndex];    const newAnswers = new Map(answers);    newAnswers.set(actualQuestion._id, answer);    setAnswers(newAnswers);    setTimeout(() => {      if (currentQuestionIndex < questions.length - 1) {        setCurrentQuestionIndex(currentQuestionIndex + 1);      }    }, 300); 
  };  const handleQuestionJump = (index: number) => {    setCurrentQuestionIndex(index);  };  const handleNext = () => {    if (currentQuestionIndex < questions.length - 1) {      setCurrentQuestionIndex(currentQuestionIndex + 1);    }  };  const handlePrevious = () => {    if (currentQuestionIndex > 0) {      setCurrentQuestionIndex(currentQuestionIndex - 1);    }  };  const handleSubmit = async () => {    if (answers.size < questions.length) {      if (!window.confirm(t('confirmSubmitIncomplete'))) {        return;      }    }    setIsSubmitting(true);    try {      const answersArray: QuizAnswer[] = Array.from(answers.entries()).map(([questionId, selectedAnswer]) => ({        questionId,        selectedAnswer,      }));      const result = await quizApi.submitQuiz(quizId!, answersArray);      if (result.success) {        toast.success('submitSuccess');        setTimeout(() => {          navigate(`/quiz/${quizId}/result`);        }, 1000);      } else {        toast.error('quizSubmitFailed', result.message);      }    } catch (error: any) {      console.error('Submit error:', error);      toast.error('quizSubmitFailed', error.message);    } finally {      setIsSubmitting(false);    }  };  if (isLoading) {    return (      <div className="min-h-screen bg-gray-50 flex items-center justify-center">        <div className="text-center">          <div className="w-32 h-32 mx-auto mb-6">            <div className="relative w-full h-full">              <div className="absolute inset-0 border-8 border-gray-200 rounded-full"></div>              <div className="absolute inset-0 border-8 border-blue-600 rounded-full border-t-transparent animate-spin"></div>            </div>          </div>          <p className="text-xl font-semibold text-gray-700 mb-2">{t('loading')}...</p>          <div className="bg-gray-200 h-2 w-64 rounded-full mx-auto overflow-hidden">            <div className="bg-blue-600 h-full w-3/4 rounded-full animate-pulse"></div>          </div>        </div>      </div>    );  }  if (!quiz || questions.length === 0) {    return (      <div className="min-h-screen bg-gray-50 flex items-center justify-center">        <div className="text-center">          <p className="text-xl text-gray-600">Quiz not found</p>          <button            onClick={() => navigate('/quizzes')}            className="mt-4 px-6 py-2 bg-gray-900 text-white rounded-lg"          >            Back to Quizzes          </button>        </div>      </div>    );  }  const currentQuestion = translateQuestion(questions[currentQuestionIndex], language);  const currentAnswer = answers.get(questions[currentQuestionIndex]._id);  const progress = ((currentQuestionIndex + 1) / questions.length) * 100;  const translatedQuiz = quiz ? translateQuiz(quiz, language) : null;  return (    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50">      {}      <div className="fixed left-0 top-0 bottom-0 w-64 bg-white border-r-2 border-gray-900 flex flex-col z-10">        {}        <div className="px-6 py-6">          <Logo size={40} showText={true} />        </div>        {}        <div className="px-6 mb-4">          <button            onClick={() => {              if (window.confirm(t('confirmExit'))) {                navigate('/quizzes');              }            }}            className="w-full flex items-center gap-2 px-4 py-2 hover:bg-gray-100 rounded-md transition-colors"          >            <ArrowLeft size={20} className="text-gray-900" />            <span className="text-sm font-medium text-gray-900">{t('back')}</span>          </button>        </div>        {}        <div className="flex-1" />        {}        {user && (          <div             onClick={() => navigate('/profile')}            className="cursor-pointer hover:bg-gray-100 p-3 mx-4 mb-4 transition-colors"          >            <div className="flex items-center gap-3">              {user.profileImage ? (                <img                  src={user.profileImage}                  alt="Profile"                  className="w-12 h-12 rounded-full object-cover border-2 border-gray-900 flex-shrink-0"                />              ) : (                <div className="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center border-2 border-gray-900 flex-shrink-0">                  <User size={24} className="text-gray-400" />                </div>              )}              <div className="flex-1 min-w-0">                <p className="font-bold text-gray-900 text-sm truncate">                  {user.name}                </p>                <p className="text-xs text-gray-600 truncate">                  {user.email}                </p>              </div>            </div>          </div>        )}      </div>      {}      <div className="ml-64">        {}        <header className="bg-white border-b border-gray-200 shadow-sm">          <div className="container mx-auto px-4 py-4">            <div className="flex justify-between items-center">              <div>                <h1 className="text-xl font-bold text-gray-900">{translatedQuiz?.title}</h1>              </div>              <LanguageSelector />            </div>          </div>        </header>      {}      <div className="bg-white border-b border-gray-200">        <div className="container mx-auto px-4 py-3">          <div className="flex items-center justify-between mb-2">            <span className="text-sm font-medium text-gray-700">              {t('question')} {currentQuestionIndex + 1} {t('of')} {questions.length}            </span>            <span className="text-sm text-gray-600">{Math.round(progress)}% {t('complete')}</span>          </div>          <div className="bg-gray-200 h-2 rounded-full overflow-hidden">            <div              className="bg-blue-600 h-full rounded-full transition-all duration-300"              style={{ width: `${progress}%` }}            ></div>          </div>        </div>      </div>      {}      <main className="container mx-auto px-4 py-8">        <div className="max-w-7xl mx-auto">          <div className="grid grid-cols-12 gap-6">            {}            <div className="col-span-3">              <div className="bg-white rounded-lg shadow-lg p-4 border-2 border-gray-200 sticky top-24">                <h3 className="font-bold text-gray-900 mb-4 text-center">                  {language === 'ja' ? '質問一覧' : 'Danh sách câu hỏi'}                </h3>                <div className="grid grid-cols-5 gap-2">                  {questions.map((q, index) => {                    const isAnswered = answers.has(questions[index]._id);                    const isCurrent = index === currentQuestionIndex;                    return (                      <button                        key={q._id}                        onClick={() => handleQuestionJump(index)}                        className={`aspect-square rounded-lg font-semibold text-sm transition-all ${                          isCurrent                            ? 'bg-blue-600 text-white ring-2 ring-blue-400'                            : isAnswered                            ? 'bg-green-500 text-white hover:bg-green-600'                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'                        }`}                      >                        {index + 1}                      </button>                    );                  })}                </div>                <div className="mt-4 pt-4 border-t border-gray-200 space-y-2 text-xs">                  <div className="flex items-center gap-2">                    <div className="w-4 h-4 bg-green-500 rounded"></div>                    <span>{language === 'ja' ? '回答済み' : 'Đã trả lời'}</span>                  </div>                  <div className="flex items-center gap-2">                    <div className="w-4 h-4 bg-blue-600 rounded ring-2 ring-blue-400"></div>                    <span>{language === 'ja' ? '現在' : 'Hiện tại'}</span>                  </div>                  <div className="flex items-center gap-2">                    <div className="w-4 h-4 bg-gray-200 rounded"></div>                    <span>{language === 'ja' ? '未回答' : 'Chưa trả lời'}</span>                  </div>                </div>              </div>            </div>            {}            <div className="col-span-9">              <div className="bg-white rounded-2xl shadow-xl p-8 border-2 border-gray-200">            {}            <div className="mb-8">              <h2 className="text-2xl font-bold text-gray-900 mb-4">                {t('question')}              </h2>              {currentQuestion.questionType === 'image' && currentQuestion.questionImageUrl && (                <div className="mb-6 bg-gray-50 rounded-lg p-6 border-2 border-gray-200">                  <img                    src={currentQuestion.questionImageUrl}                    alt="Question"                    className="max-w-full mx-auto"                    style={{ maxHeight: '400px' }}                  />                </div>              )}              <p className="text-lg text-gray-700">                {currentQuestion.questionText}              </p>            </div>            {}            {isSubmitting && (              <div className="mb-8 bg-blue-50 rounded-lg p-12 border-2 border-blue-200">                <div className="text-center">                  <div className="w-16 h-16 mx-auto mb-4">                    <div className="relative w-full h-full">                      <div className="absolute inset-0 border-4 border-blue-200 rounded-full"></div>                      <div className="absolute inset-0 border-4 border-blue-600 rounded-full border-t-transparent animate-spin"></div>                    </div>                  </div>                  <p className="text-blue-900 font-semibold">{t('scoring')}...</p>                </div>              </div>            )}            {}            <div className="space-y-3">              {currentQuestion.questionType === 'text' && currentQuestion.textOptions ? (                getOceanOptions(language).map((option: string, index: number) => (                  <button                    key={index}                    onClick={() => handleAnswerSelect(index)}                    className={`w-full p-4 text-left rounded-lg border-2 transition-all ${                      currentAnswer === index                        ? 'border-blue-600 bg-blue-50'                        : 'border-gray-200 hover:border-gray-400 bg-white'                    }`}                  >                    <div className="flex items-center gap-3">                      <div                        className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${                          currentAnswer === index                            ? 'border-blue-600 bg-blue-600'                            : 'border-gray-300'                        }`}                      >                        {currentAnswer === index && (                          <div className="w-3 h-3 bg-white rounded-full"></div>                        )}                      </div>                      <span className="text-gray-700 font-medium">{option}</span>                    </div>                  </button>                ))              ) : currentQuestion.questionType === 'image' && currentQuestion.imageOptions ? (                <div className="grid grid-cols-4 gap-4">                  {currentQuestion.imageOptions.map((option: any, index: number) => {                    const optionLabel = typeof option.label === 'object'                       ? (option.label[language] || option.label.ja)                      : option.label;                    return (                      <button                        key={index}                        onClick={() => handleAnswerSelect(index)}                        className={`p-4 rounded-lg border-2 transition-all ${                          currentAnswer === index                            ? 'border-blue-600 bg-blue-50 ring-2 ring-blue-400'                            : 'border-gray-200 hover:border-gray-400 bg-white'                        }`}                      >                        <img                          src={option.imageUrl}                          alt={optionLabel}                          className="w-full mb-2"                        />                        <p className="text-center text-sm font-medium text-gray-700">                          {optionLabel}                        </p>                      </button>                    );                  })}                </div>              ) : null}            </div>            {}            <div className="mt-8 flex justify-between items-center">              <button                onClick={handlePrevious}                disabled={currentQuestionIndex === 0}                className="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"              >                ← {t('previous')}              </button>              <div className="text-sm text-gray-600">                {answers.size} {t('of')} {questions.length} {t('answered')}              </div>              {answers.size === questions.length ? (                <button                  onClick={handleSubmit}                  disabled={isSubmitting}                  className="px-8 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-colors disabled:cursor-not-allowed"                >                  {isSubmitting ? t('submitting') : t('submit')}                </button>              ) : (                <button                  onClick={handleNext}                  disabled={currentQuestionIndex === questions.length - 1}                  className="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"                >                  {t('next')} →                </button>              )}            </div>            {}            {answers.size < questions.length && currentQuestionIndex === questions.length - 1 && (              <div className="mt-4 bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4 text-center">                <p className="text-yellow-800 font-medium">                  {language === 'ja'                     ? `まだ ${questions.length - answers.size} 問未回答です。すべての質問に答えてから提出してください。`                    : `Còn ${questions.length - answers.size} câu chưa trả lời. Vui lòng trả lời hết để nộp bài.`                  }                </p>              </div>            )}              </div>            </div>          </div>        </div>      </main>      </div>    </div>  );};export default QuizTaking;