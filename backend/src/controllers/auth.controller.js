import User from '../models/User.model.js';import { generateToken } from '../utils/jwt.js';import { validationResult } from 'express-validator';import { body } from 'express-validator';export const register = async (req, res) => {  try {    const errors = validationResult(req);    if (!errors.isEmpty()) {      return res.status(400).json({         success: false,         errors: errors.array()       });    }    const { email, password, name, role, location, studentId, selfIntro, gender } = req.body;    const existingUser = await User.findOne({ email });    if (existingUser) {      return res.status(400).json({        success: false,        message: 'User with this email already exists',      });    }    if (role === 'student' && studentId) {      const existingStudentId = await User.findOne({ studentId: studentId.trim() });      if (existingStudentId) {        return res.status(400).json({          success: false,          message: 'Student ID (MSSV) already exists. Please use a different student ID.',        });      }    }    const user = await User.create({      email,      password,      name,      role: role || 'student',      location,      studentId: role === 'student' ? studentId : undefined,      selfIntro,      gender: gender || null,      profileImage: req.file ? `/uploads/${req.file.filename}` : null,    });    const token = generateToken(user._id);    user.lastLogin = new Date();    await user.save();    res.status(201).json({      success: true,      message: 'User registered successfully',      data: {        user: user.getPublicProfile(),        token,      },    });  } catch (error) {    console.error('Register error:', error);    res.status(500).json({      success: false,      message: 'Server error during registration',      error: error.message,    });  }};export const login = async (req, res) => {  try {    const errors = validationResult(req);    if (!errors.isEmpty()) {      return res.status(400).json({         success: false,         errors: errors.array()       });    }    const { email, password } = req.body;    const user = await User.findOne({ email }).select('+password');    if (!user) {      return res.status(401).json({        success: false,        message: 'Invalid email or password',      });    }    const isPasswordValid = await user.comparePassword(password);    if (!isPasswordValid) {      return res.status(401).json({        success: false,        message: 'Invalid email or password',      });    }    const token = generateToken(user._id);    user.lastLogin = new Date();    await user.save();    res.json({      success: true,      message: 'Login successful',      data: {        user: user.getPublicProfile(),        token,      },    });  } catch (error) {    console.error('Login error:', error);    res.status(500).json({      success: false,      message: 'Server error during login',      error: error.message,    });  }};export const getMe = async (req, res) => {  try {    const user = await User.findById(req.user.id);    res.json({      success: true,      data: {        user: user.getPublicProfile(),      },    });  } catch (error) {    console.error('Get me error:', error);    res.status(500).json({      success: false,      message: 'Server error',      error: error.message,    });  }};export const googleCallback = async (req, res) => {  try {    if (!req.user) {      return res.redirect(`${process.env.CLIENT_URL}/auth/error?message=Authentication failed`);    }    if (req.user.isPending) {      req.session.pendingUser = {        googleId: req.user.googleId,        email: req.user.email,        name: req.user.name,        profileImage: req.user.profileImage,        isEmailVerified: req.user.isEmailVerified,      };      return res.redirect(`${process.env.CLIENT_URL}/auth/google/role-selection`);    }    const token = generateToken(req.user._id);    res.redirect(`${process.env.CLIENT_URL}/auth/success?token=${token}`);  } catch (error) {    console.error('Google callback error:', error);    res.redirect(`${process.env.CLIENT_URL}/auth/error?message=${encodeURIComponent(error.message)}`);  }};export const completeGoogleRegistration = async (req, res) => {  try {    const { role, name, gender, studentId, selfIntro } = req.body;    if (!role || !['student', 'teacher'].includes(role)) {      return res.status(400).json({        success: false,        message: 'Invalid role. Must be student or teacher',      });    }    if (!name || !name.trim()) {      return res.status(400).json({        success: false,        message: 'Name is required',      });    }    if (!gender || !['male', 'female', 'other'].includes(gender)) {      return res.status(400).json({        success: false,        message: 'Gender is required',      });    }    if (!req.session.pendingUser) {      return res.status(400).json({        success: false,        message: 'No pending registration found. Please try again.',      });    }    const pendingUser = req.session.pendingUser;    let user = await User.findOne({ googleId: pendingUser.googleId });    if (user) {      req.session.pendingUser = null;      const token = generateToken(user._id);      return res.json({        success: true,        message: 'User already exists',        data: {          user: user.getPublicProfile(),          token,        },      });    }    user = await User.findOne({ email: pendingUser.email });    if (user) {      user.googleId = pendingUser.googleId;      user.isEmailVerified = true;      if (!user.profileImage && pendingUser.profileImage) {        user.profileImage = pendingUser.profileImage;      }      user.lastLogin = new Date();      await user.save();      req.session.pendingUser = null;      const token = generateToken(user._id);      return res.json({        success: true,        message: 'Google account linked successfully',        data: {          user: user.getPublicProfile(),          token,        },      });    }    if (role === 'student') {      if (!studentId || !studentId.trim()) {        return res.status(400).json({          success: false,          message: 'Student ID (MSSV) is required for students',        });      }      const existingStudentId = await User.findOne({ studentId: studentId.trim() });      if (existingStudentId) {        return res.status(400).json({          success: false,          message: 'Student ID (MSSV) already exists. Please use a different student ID.',        });      }    }    const newUser = await User.create({      googleId: pendingUser.googleId,      email: pendingUser.email,      name: name.trim(),      gender: gender,      profileImage: pendingUser.profileImage,      isEmailVerified: true,      role: role,      studentId: role === 'student' && studentId ? studentId.trim() : undefined,      selfIntro: selfIntro ? selfIntro.trim() : undefined,      lastLogin: new Date(),    });    req.session.pendingUser = null;    const token = generateToken(newUser._id);    res.status(201).json({      success: true,      message: 'Registration completed successfully',      data: {        user: newUser.getPublicProfile(),        token,      },    });  } catch (error) {    console.error('Complete Google registration error:', error);    res.status(500).json({      success: false,      message: 'Server error during registration',      error: error.message,    });  }};export const logout = async (req, res) => {  try {    res.json({      success: true,      message: 'Logout successful',    });  } catch (error) {    console.error('Logout error:', error);    res.status(500).json({      success: false,      message: 'Server error during logout',      error: error.message,    });  }};